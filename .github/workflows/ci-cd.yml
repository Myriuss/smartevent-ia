name: CI-CD

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch: {}

jobs:
  # 1) BUILD (tous les builds dans un seul job logique)
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Build microservices
        run: |
          mvn -f auth-service/pom.xml clean package -DskipTests
          mvn -f event-service/pom.xml clean package -DskipTests
          mvn -f config-server/pom.xml clean package -DskipTests
          mvn -f eureka-server/pom.xml clean package -DskipTests
          mvn -f gateway-service/pom.xml clean package -DskipTests

      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build front
        working-directory: front
        run: |
          npm ci
          npm run build

      - name: Build frontAdmin
        working-directory: frontAdmin
        run: |
          npm ci
          npm run build

      - name: Build workflow-service
        working-directory: workflow-service
        run: |
          npm ci
          npm run build || echo "pas de build dédié"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build ai-service
        working-directory: ai-service
        run: |
          pip install -r requirements.txt
          python -m py_compile $(find . -name "*.py")

  # 2) TEST (tous les tests dans un seul job)
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Tests front
        working-directory: front
        run: |
          npm ci
          npm test -- --watch=false --browsers=ChromeHeadless || echo "tests simples"

      - name: Tests frontAdmin
        working-directory: frontAdmin
        run: |
          npm ci
          npm test -- --watch=false --browsers=ChromeHeadless || echo "tests simples"

      - name: Tests workflow-service
        working-directory: workflow-service
        run: |
          npm ci
          npm test || echo "tests simples"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Tests ai-service
        working-directory: ai-service
        run: |
          pip install -r requirements.txt
          pytest || echo "tests simples"

  # 3) ANALYZE (Semgrep et SonarQube)
  analyze_semgrep:
    name: analyze_semgrep
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep scan --config p/ci --error

  # 4) DOCKER BUILD & PUSH
  docker-build:
    runs-on: ubuntu-latest
    # attend que TOUT le build & test soit terminé
    needs:
      - analyze_semgrep

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build images
        run: docker compose -f docker-compose.yml build

      - name: Push images
        run: docker compose -f docker-compose.yml push

  # 5) DEPLOY
  deploy:
    runs-on: ubuntu-latest
    # ne part que si les images sont build & push
    needs: docker-build

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /home/azureuser/smartevent-ia
            git checkout dev
            git pull origin dev
            docker compose pull
            docker compose --profile ui up -d --remove-orphans
            docker ps
