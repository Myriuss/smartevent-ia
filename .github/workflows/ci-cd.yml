name: CI-CD

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch: {}

jobs:
  # 1) BUILD & TEST

  build-maven:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      - name: Build microservices
        run: |
          mvn -f auth-service/pom.xml clean package -DskipTests
          mvn -f event-service/pom.xml clean package -DskipTests
          mvn -f config-server/pom.xml clean package -DskipTests
          mvn -f eureka-server/pom.xml clean package -DskipTests
          mvn -f gateway-service/pom.xml clean package -DskipTests

  build-front:
    runs-on: ubuntu-latest
    needs: build-maven
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build front
        working-directory: front
        run: |
          npm ci
          npm run build

  build-front-admin:
    runs-on: ubuntu-latest
    needs: build-maven
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build frontAdmin
        working-directory: frontAdmin
        run: |
          npm ci
          npm run build

  build-workflow:
    runs-on: ubuntu-latest
    needs: build-maven
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build workflow-service
        working-directory: workflow-service
        run: |
          npm ci
          npm run build || echo "pas de build dédié"

  build-ai:
    runs-on: ubuntu-latest
    needs: build-maven
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Build ai-service
        working-directory: ai-service
        run: |
          pip install -r requirements.txt
          python -m py_compile $(find . -name "*.py")

  test-front:
    runs-on: ubuntu-latest
    needs: build-front
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Tests front
        working-directory: front
        run: |
          npm ci
          npm test -- --watch=false --browsers=ChromeHeadless || echo "tests simples"

  test-front-admin:
    runs-on: ubuntu-latest
    needs: build-front-admin
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Tests frontAdmin
        working-directory: frontAdmin
        run: |
          npm ci
          npm test -- --watch=false --browsers=ChromeHeadless || echo "tests simples"

  test-workflow:
    runs-on: ubuntu-latest
    needs: build-workflow
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Tests workflow-service
        working-directory: workflow-service
        run: |
          npm ci
          npm test || echo "tests simples"

  test-ai:
    runs-on: ubuntu-latest
    needs: build-ai
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Tests ai-service
        working-directory: ai-service
        run: |
          pip install -r requirements.txt
          pytest || echo "tests simples"

  # 2) DOCKER BUILD & PUSH
  docker-build-push:
    runs-on: ubuntu-latest
    # attend que TOUT le build & test soit terminé
    needs:
      - test-front
      - test-front-admin
      - test-workflow
      - test-ai

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build images
        run: docker compose -f docker-compose.yml build

      - name: Push images
        run: docker compose -f docker-compose.yml push

  # 3) DEPLOY
  #deploy:
  #runs-on: ubuntu-latest
  # ne part que si les images sont build & push
  #needs: docker-build-push

  #steps:
  #- name: Deploy over SSH
  #  uses: appleboy/ssh-action@v1
  #  with:
  #    host: ${{ secrets.DEPLOY_HOST }}
  #    username: ${{ secrets.DEPLOY_USER }}
  #    key: ${{ secrets.DEPLOY_SSH_KEY }}
  #    script: |
  #      cd /home/azureuser/smartevent-ia
  #     git checkout dev
  #      git pull origin dev
  #      docker compose pull
  #      docker compose up -d --remove-orphans
  #      docker ps
  deploy_local:
    runs-on: windows-latest
    needs: docker-build-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Déploiement local avec Docker Desktop
        shell: powershell
        run: |
          # Aller dans le dossier du projet
          Set-Location -Path "E:\ESIC\Cloud_Computing_DevOps_DevSecOps\local\smartevent-ia-main"

          # Mettre à jour le code
          git checkout dev
          git pull origin dev

          # Pull et relance des containers
          docker compose pull
          docker compose up -d --remove-orphans

          # Vérifier les containers
          docker ps
