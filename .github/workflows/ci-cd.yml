name: CI-CD

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch: {}

jobs:
  # 1) BUILD (tous les builds dans un seul job logique)
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build microservices
        run: |
          mvn -f auth-service/pom.xml clean package -DskipTests
          mvn -f event-service/pom.xml clean package -DskipTests
          mvn -f config-server/pom.xml clean package -DskipTests
          mvn -f eureka-server/pom.xml clean package -DskipTests
          mvn -f gateway-service/pom.xml clean package -DskipTests

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build front
        working-directory: front
        run: |
          npm ci
          npm run build

      - name: Build frontAdmin
        working-directory: frontAdmin
        run: |
          npm ci
          npm run build

      - name: Build workflow-service
        working-directory: workflow-service
        run: |
          npm ci
          npm run build || echo "pas de build dédié"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build ai-service
        working-directory: ai-service
        run: |
          pip install -r requirements.txt
          python -m py_compile $(find . -name "*.py")

  # 2) TEST (tous les tests dans un seul job)
  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Tests front
        working-directory: front
        run: |
          npm ci
          npm test -- --watch=false --browsers=ChromeHeadless || echo "tests simples"

      - name: Tests frontAdmin
        working-directory: frontAdmin
        run: |
          npm ci
          npm test -- --watch=false --browsers=ChromeHeadless || echo "tests simples"

      - name: Tests workflow-service
        working-directory: workflow-service
        run: |
          npm ci
          npm test || echo "tests simples"

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Tests ai-service
        working-directory: ai-service
        run: |
          pip install -r requirements.txt
          pytest || echo "tests simples"

  # 3) ANALYZE (Semgrep et SonarQube)
  analyze_semgrep:
    name: analyze_semgrep
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: |
          python3 -m pip install --upgrade pip
          pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep scan --config p/ci --error

  analyze_sonar:
    name: analyze_sonar
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # recommandé pour SonarQube

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache SonarQube packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2-

      # ---- Java services via Maven ----
      - name: Sonar - auth-service
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn verify sonar:sonar \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.projectKey=smartevent-ia-auth \
            -Dsonar.projectName="smartevent-ia-auth"

      - name: Sonar - event-service
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn verify sonar:sonar \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.projectKey=smartevent-ia-event \
            -Dsonar.projectName="smartevent-ia-event"

      - name: Sonar - config-server
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn verify sonar:sonar \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.projectKey=smartevent-ia-config \
            -Dsonar.projectName="smartevent-ia-config"

      - name: Sonar - eureka-server
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn verify sonar:sonar \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.projectKey=smartevent-ia-eureka \
            -Dsonar.projectName="smartevent-ia-eureka"

      - name: Sonar - gateway-service
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          mvn verify sonar:sonar \
            -Dsonar.host.url=http://sonarqube:9000 \
            -Dsonar.token=${SONAR_TOKEN} \
            -Dsonar.projectKey=smartevent-ia-gateway \
            -Dsonar.projectName="smartevent-ia-gateway"

      # ---- Analyse front ----
      - name: Sonar - front
        working-directory: front
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          npx sonar-scanner \
            -Dsonar.projectKey=smartevent-front \
            -Dsonar.projectName="smartevent-front" \
            -Dsonar.sources=src \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      - name: Sonar - frontAdmin
        working-directory: frontAdmin
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          npx sonar-scanner \
            -Dsonar.projectKey=smartevent-front-admin \
            -Dsonar.projectName="smartevent-front-admin" \
            -Dsonar.sources=src \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      - name: Sonar - workflow-service
        working-directory: workflow-service
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          npx sonar-scanner \
            -Dsonar.projectKey=smartevent-workflow \
            -Dsonar.projectName="smartevent-workflow" \
            -Dsonar.sources=src \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

      # ---- analyse ai-service ----
      - name: Install SonarScanner CLI
        run: |
          curl -sSLo sonar-scanner.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner.zip
          mv sonar-scanner-*/ sonar-scanner
          echo "${PWD}/sonar-scanner/bin" >> $GITHUB_PATH

      - name: SonarQube analysis (ai-service)
        working-directory: ai-service
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          sonar-scanner \
            -Dsonar.projectKey=smartevent-ai \
            -Dsonar.sources=. \
            -Dsonar.python.version=3.11 \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.login=${SONAR_TOKEN}

  # 4) DOCKER BUILD & PUSH
  docker-build:
    runs-on: ubuntu-latest
    needs:
      - analyze_semgrep
      - analyze_sonar
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.CR_PAT }}

      - name: Build images
        run: docker compose -f docker-compose.yml build

      - name: Push images
        run: docker compose -f docker-compose.yml push

  # 5) DEPLOY
  deploy:
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd /home/azureuser/smartevent-ia
            git checkout dev
            git pull origin dev
            docker compose build
            docker compose --profile ui up -d --force-recreate
            docker ps
