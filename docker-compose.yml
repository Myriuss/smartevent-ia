services:
  postgres:
    image: postgres:16-alpine
    container_name: smartevent_postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 20

  eureka-server:
    build: ./eureka-server
    container_name: smartevent_eureka
    ports:
      - "8761:8761"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8761/actuator/health | grep -q UP"]
      interval: 10s
      timeout: 5s
      retries: 30

  config-server:
    build: ./config-server
    container_name: smartevent_config
    ports:
      - "8888:8888"
    volumes:
      - ./config-repo:/config-repo:ro
    environment:
      SPRING_PROFILES_ACTIVE: native
      SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCH_LOCATIONS: file:/config-repo
    depends_on:
      eureka-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8888/actuator/health | grep -q UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  auth-service:
    build: ./auth-service
    container_name: smartevent_auth
    ports:
      - "8091:8091"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    depends_on:
      postgres:
        condition: service_healthy
      config-server:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8091/actuator/health | grep -q UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  event-service:
    build: ./event-service
    container_name: smartevent_event
    ports:
      - "8090:8090"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    depends_on:
      postgres:
        condition: service_healthy
      config-server:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8090/actuator/health | grep -q UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  ai-service:
    build: ./ai-service
    container_name: smartevent_ai
    ports:
      - "8000:8000"
    environment:
      EUREKA_SERVER_URL: http://eureka-server:8761/eureka/
      INSTANCE_HOST: ai-service
      INSTANCE_PORT: 8000
      OLLAMA_URL: http://ollama:11434/api/generate
      OLLAMA_MODEL: mistral
    depends_on:
      eureka-server:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/docs >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  workflow-service:
    build: ./workflow-service
    container_name: smartevent_workflow
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      GATEWAY_BASE_URL: http://gateway-service:8080
      EUREKA_HOST: eureka-server
      EUREKA_PORT: 8761
      INSTANCE_HOSTNAME: workflow-service
      INSTANCE_IP: workflow-service
    depends_on:
      eureka-server:
        condition: service_healthy
      gateway-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3000/workflow/health | grep -q UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  gateway-service:
    build: ./gateway-service
    container_name: smartevent_gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    depends_on:
      config-server:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      event-service:
        condition: service_healthy
      ai-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/actuator/health | grep -q UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  # LLM local (optionnel). Active avec: docker compose --profile llm up
  ollama:
    image: ollama/ollama:latest
    profiles: ["llm"]
    container_name: smartevent_ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

  # UI (optionnel). Active avec: docker compose --profile ui up
  front:
    build: ./front
    profiles: ["ui"]
    container_name: smartevent_front
    ports:
      - "4200:80"
    depends_on:
      gateway-service:
        condition: service_healthy

  frontadmin:
    build: ./frontAdmin
    profiles: ["ui"]
    container_name: smartevent_front_admin
    ports:
      - "4201:80"
    depends_on:
      gateway-service:
        condition: service_healthy

volumes:
  postgres_data:
  ollama_data:
